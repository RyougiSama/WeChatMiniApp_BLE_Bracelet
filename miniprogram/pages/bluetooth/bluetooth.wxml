<!--bluetooth.wxml-->
<view class="container">
  <!-- 连接状态卡片 -->
  <view class="status-card">
    <view class="status-header">
      <view class="status-icon {{bluetoothEnabled ? 'active' : 'inactive'}}">
        {{bluetoothEnabled ? '📶' : '📵'}}
      </view>
      <view class="status-info">
        <text class="status-title">连接状态</text>
        <text class="status-desc">
          {{connected ? '已连接' : (bluetoothEnabled ? '蓝牙已开启' : '蓝牙未开启')}}
        </text>
      </view>
    </view>
    <view class="device-info" wx:if="{{connected && connectedDevice}}">
      <view class="device-badge">
        <text class="device-name">{{connectedDevice.name}}</text>
        <text class="device-signal">{{connectedDevice.RSSI}}dBm</text>
      </view>
    </view>
  </view>

  <!-- 设备扫描区域 -->
  <view class="scan-section" wx:if="{{!connected}}">
    <view class="section-header">
      <text class="section-title">发现设备</text>
      <text class="section-subtitle">搜索附近的智能手环</text>
    </view>

    <!-- 扫描提示 -->
    <view class="scan-tip">
      <view class="tip-icon">💡</view>
      <text class="tip-text">请确保手环处于配对模式且未被其他设备连接</text>
    </view>

    <!-- 扫描控制按钮 -->
    <view class="scan-controls">
      <button class="scan-btn {{scanning ? 'scanning' : ''}}" 
              bindtap="startScan" 
              disabled="{{!bluetoothEnabled || scanning}}">
        <view class="btn-content">
          <text class="btn-icon">{{scanning ? '🔄' : '🔍'}}</text>
          <text class="btn-text">{{scanning ? '扫描中...' : '开始扫描'}}</text>
        </view>
      </button>
      
      <view class="control-buttons" wx:if="{{devices.length > 0 || scanning}}">
        <button class="secondary-btn" bindtap="refreshScan" 
                disabled="{{!bluetoothEnabled || scanning}}" 
                wx:if="{{!scanning}}">
          <text class="btn-text">刷新</text>
        </button>
        <button class="danger-btn" bindtap="stopScan" wx:if="{{scanning}}">
          <text class="btn-text">停止</text>
        </button>
      </view>
    </view>

    <!-- 设备列表 -->
    <view class="device-section" wx:if="{{devices.length > 0}}">
      <view class="device-header">
        <text class="device-count">发现 {{devices.length}} 个设备</text>
      </view>
      <view class="device-list">
        <view class="device-card" 
              wx:for="{{devices}}" 
              wx:key="deviceId"
              bindtap="connectDevice"
              data-deviceid="{{item.deviceId}}">
          <view class="device-avatar">⌚</view>
          <view class="device-details">
            <text class="device-name">{{item.name || '未知设备'}}</text>
            <text class="device-signal">信号强度: {{item.RSSI}}dBm</text>
          </view>
          <view class="connect-arrow">→</view>
        </view>
      </view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{devices.length === 0 && !scanning}}">
      <view class="empty-icon">🔍</view>
      <text class="empty-title">未发现设备</text>
      <text class="empty-desc">点击开始扫描按钮搜索附近的智能手环</text>
    </view>
  </view>

  <!-- 数据通信区域 -->
  <view class="communication-section" wx:if="{{connected}}">
    <view class="section-header">
      <text class="section-title">数据通信</text>
      <button class="disconnect-btn" bindtap="disconnect">
        <text class="btn-text">断开连接</text>
      </button>
    </view>

    <!-- 数据监控面板 -->
    <view class="data-panel">
      <view class="panel-header">
        <view class="panel-title">
          <text class="title-text">实时数据</text>
          <text class="title-status">●</text>
        </view>
        <view class="panel-controls">
          <button class="mode-toggle" bindtap="toggleDisplayMode">
            <text class="mode-text">{{displayMode === 'ascii' ? 'ASCII' : 'HEX'}}</text>
            <text class="mode-icon">🔄</text>
          </button>
          <button class="clear-btn" bindtap="clearData">
            <text class="btn-text">清空</text>
          </button>
        </view>
      </view>
      
      <scroll-view class="data-content" scroll-y scroll-top="{{receivedData.length * 100}}">
        <view class="data-item {{item.type}}" wx:for="{{receivedData}}" wx:key="index">
          <view class="data-indicator">
            <text class="data-icon">{{item.type === 'send' ? '📤' : '📥'}}</text>
            <text class="data-time">{{item.timestamp}}</text>
          </view>
          <view class="data-content-wrapper">
            <view class="data-message" wx:if="{{displayMode === 'ascii'}}">
              {{item.command || item.ascii}}
            </view>
            <view class="data-message hex-message" wx:if="{{displayMode === 'hex'}}">
              {{item.hex}}
            </view>
          </view>
        </view>
        <view class="empty-data" wx:if="{{receivedData.length === 0}}">
          <view class="empty-icon">📡</view>
          <text class="empty-text">等待接收数据...</text>
        </view>
      </scroll-view>
    </view>

    <!-- 智能控制面板 -->
    <view class="control-panel">
      <view class="panel-header">
        <text class="panel-title">智能控制</text>
        <text class="panel-subtitle">点击按钮获取手环数据</text>
      </view>
      
      <!-- 控制按钮网格 -->
      <view class="control-grid">
        <button class="control-btn temperature" bindtap="sendQuickCommand" data-command="temperature">
          <view class="btn-icon-wrapper">
            <text class="btn-icon">🌡️</text>
          </view>
          <view class="btn-info">
            <text class="btn-title">温度检测</text>
            <text class="btn-desc">获取实时温度数据</text>
          </view>
          <view class="btn-indicator">
            <text class="indicator-dot">●</text>
          </view>
        </button>
        
        <button class="control-btn heart-rate" bindtap="sendQuickCommand" data-command="heart_rate">
          <view class="btn-icon-wrapper">
            <text class="btn-icon">💊</text>
          </view>
          <view class="btn-info">
            <text class="btn-title">健康数据</text>
            <text class="btn-desc">获取完整健康数据</text>
          </view>
          <view class="btn-indicator">
            <text class="indicator-dot">●</text>
          </view>
        </button>
        
        <button class="control-btn steps" bindtap="sendQuickCommand" data-command="steps">
          <view class="btn-icon-wrapper">
            <text class="btn-icon">👟</text>
          </view>
          <view class="btn-info">
            <text class="btn-title">步数统计</text>
            <text class="btn-desc">查看今日步数数据</text>
          </view>
          <view class="btn-indicator">
            <text class="indicator-dot">●</text>
          </view>
        </button>
        
        <button class="control-btn location" bindtap="sendQuickCommand" data-command="location">
          <view class="btn-icon-wrapper">
            <text class="btn-icon">🌍</text>
          </view>
          <view class="btn-info">
            <text class="btn-title">定位查询</text>
            <text class="btn-desc">获取设备位置信息</text>
          </view>
          <view class="btn-indicator">
            <text class="indicator-dot">●</text>
          </view>
        </button>
        
        <button class="control-btn gps-sync" bindtap="sendQuickCommand" data-command="gps_sync">
          <view class="btn-icon-wrapper">
            <text class="btn-icon">📍</text>
          </view>
          <view class="btn-info">
            <text class="btn-title">同步定位</text>
            <text class="btn-desc">发送当前GPS位置</text>
          </view>
          <view class="btn-indicator">
            <text class="indicator-dot">●</text>
          </view>
        </button>

      </view>
    </view>
  </view>
</view>